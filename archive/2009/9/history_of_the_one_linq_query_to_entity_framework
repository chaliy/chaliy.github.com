<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>  
	<title>Mike Chaliy: History of the one LINQ to Entities query</title>
	<meta name="description" content="The story about progressive enchantments to the single LINQ to Entities queries. Some sort of stuff to know, when doing LINQ." />
	<meta name="keywords" content="ADO.NET Data Services, Entity Framework, LINQ" />

	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<meta name="Geography" content="Kyiv, Ukraine">
	<meta name="City" content="Kyiv">
	<meta name="Country" content="Ukraine">
	<meta name="Language" content="English">
	<meta name="Author" content="Mike Chaliy" />
	<link href="/stylesheets/style.css?1279376199" media="all" rel="stylesheet" type="text/css" />
	<link href="/stylesheets/print.css?1254176669" media="print" rel="stylesheet" type="text/css" />	
	<link rel="alternate" type="application/atom+xml" title="Mike Chaliy, Blog" href="http://feeds.feedburner.com/chaliy" />
</head>
<body>
        
	        <div id="menu">
            <ul>
            	<li><a href="/">Home</a></li>
                <li><a href="http://blog.chaliy.name">Blog</a></li>
				
				<li><a href="/home/contacts">Contacts</a></li>
            </ul>
        </div>
		
        <div id="header">
        	<p>Mike Chaliy's Personal Site</p>
			<a class="rss" type="application/atom+xml" title="Mike Chaliy, Blog" href="http://feeds.feedburner.com/chaliy" >My RSS Feed.</a>	
		</div>
	       	    	       
	
		
	<div id="main">
                
		<h1>History of the one LINQ to Entities query</h1>
<div class="entry">	
	<p>From last week, our approach to reporting has been changed. Now we use ADO.NET Data Services on top of the Entity Framework Model. Today was the first day, when I was not able to express query in terms of the ADO.NET Data Services query options.</p>

<p>Often this is not a problem because <code>Data Services</code> supports awesome feature - <a href='http://blogs.msdn.com/marcelolr/archive/2008/01/21/service-operations-in-ado-net-data-services.aspx'>Service Operations</a>. Even more exiting that methods return a <code>IQueryable&lt;T&gt;</code> automatically get support for all query options like <code>$filter</code> and <code>$orderby</code>. So what I need is some code that will retrieve required data and then return it as a <code>IQueryable&lt;T&gt;</code>.</p>

<h3 id='the_problem'>The problem</h3>

<p><img src='http://chaliy.name/files/history_of_the_one_linq_query_to_entity_framework/relationships.png' alt='Model' /></p>

<p>I have regular Order model. Customer has many Orders, Order has many OrderItems, many OrderItems have Product. Pretty common.</p>

<p>I need to retrieve all Products that Customer bought. With SQL, it is pretty easy with few joins. What about LINQ?</p>

<h3 id='short_1_direct_translation_of_the_sql_to_linq'>Short #1. Direct translation of the SQL to LINQ</h3>

<p>Well, it might look as the following:</p>

<pre><code>var r = from c in ds.Customers
	join o in ds.Orders on c equals o.Customer
	join oi in ds.OrderItems on o equals oi.Order
	join p in ds.OrderProducts on oi.OrderProduct equals p
	where c.CustomerID == customerId
	select p;</code></pre>

<p>Here <code>ds</code> is Entity Framework context. Very familiar. Imagine my disappointment when I saw stuff generated by Entity Framework.</p>

<pre><code>exec sp_executesql N&#39;SELECT 
	...
FROM    [Invoicing].[Customer] AS [Extent1]
INNER JOIN [Invoicing].[Order] AS [Extent2] ON  EXISTS (SELECT 
	cast(1 as bit) AS [C1]
	FROM    ( SELECT cast(1 as bit) AS X ) AS [SingleRowTable1]
	LEFT OUTER JOIN  (SELECT 
		[Extent3].[CustomerID] AS [CustomerID]
		FROM [Invoicing].[Customer] AS [Extent3]
		WHERE [Extent2].[CustomerID] = [Extent3].[CustomerID] ) 
			AS [Project1] ON 1 = 1
	...
	WHERE ([Extent1].[CustomerID] = [Project1].[CustomerID]) 
		OR (([Extent1].[CustomerID] IS NULL) 
		AND ([Project2].[CustomerID] IS NULL))
)
INNER JOIN [Invoicing].[OrderItem] AS [Extent5] ON  EXISTS (SELECT 
	...
)
INNER JOIN [Invoicing].[OrderProduct] AS [Extent8] ON  EXISTS (SELECT 
	...
)
WHERE [Extent1].[CustomerID] = @p__linq__1&#39;,N&#39;@p__linq__1 uniqueidentifier&#39;,
	@p__linq__1=&#39;F5DD85CF-CE1E-E2D1-3171-650938ABD2B7&#39;</code></pre>

<p><a href='http://chaliy.name/files/history_of_the_one_linq_query_to_entity_framework/short1_generated_stuff.sql'>Download full script</a> if you interested in. The Execution Plan was terrible. Just terrible. I can send this plan as example of plan to avoid&#8230;.</p>

<p>Of course, this is not acceptable. So next:</p>

<h3 id='short_2_reversed_order_of_the_joins'>Short #2. Reversed order of the joins</h3>

<p>May be change of the order will help?</p>

<pre><code>var r = from p in ds.OrderProducts
	join oi in ds.OrderItems on p equals oi.OrderProduct
	join o in ds.Orders on oi.Order equals o
	join c in ds.Customers on o.Customer equals c
	where c.CustomerID == customerId
	select p;</code></pre>

<p>No ;(. So next:</p>

<h3 id='short_3_lets_reduce_joins'>Short #3. Lets reduce joins</h3>

<p>When doing <code>LINQ</code>, it&#8217;s probably worth to remember that you have dot notation. Dot notation is pretty powerfull. So I just rewrote where clause to reduce 75% of my joins.</p>

<pre><code>var r = from p in ds.OrderProducts
	join oi in ds.OrderItems on p equals oi.OrderProduct
	where oi.Order.Customer.CustomerID == customerId
	select p;</code></pre>

<p>Looks better? Sure. Generated stuff also looks much better.</p>

<pre><code>exec sp_executesql N&#39;SELECT 
...
FROM   [Invoicing].[OrderProduct] AS [Extent1]
INNER JOIN [Invoicing].[OrderItem] AS [Extent2] ON  EXISTS (SELECT 
	cast(1 as bit) AS [C1]
	FROM    ( SELECT cast(1 as bit) AS X ) AS [SingleRowTable1]
	LEFT OUTER JOIN  (SELECT 
		[Extent3].[OrderProductID] AS [OrderProductID]
		FROM [Invoicing].[OrderProduct] AS [Extent3]
		WHERE [Extent2].[OrderProductID] = [Extent3].[OrderProductID] ) 
			AS [Project1] ON 1 = 1
	LEFT OUTER JOIN  (SELECT 
		[Extent4].[OrderProductID] AS [OrderProductID]
		FROM [Invoicing].[OrderProduct] AS [Extent4]
		WHERE [Extent2].[OrderProductID] = [Extent4].[OrderProductID] ) 
			AS [Project2] ON 1 = 1
	WHERE ([Extent1].[OrderProductID] = [Project1].[OrderProductID]) 
		OR (([Extent1].[OrderProductID] IS NULL) 
			AND ([Project2].[OrderProductID] IS NULL))
)
INNER JOIN [Invoicing].[Order] AS [Extent5] 
	ON [Extent2].[OrderID] = [Extent5].[OrderID]
WHERE [Extent5].[CustomerID] = @p__linq__1&#39;,N&#39;@p__linq__1 uniqueidentifier&#39;,
	@p__linq__1=&#39;F5DD85CF-CE1E-E2D1-3171-650938ABD2B7&#39;</code></pre>

<p>Only one crazy <code>INNER JOIN</code>. BTW, possible that I am not aware of something. I do not understand why <code>Entity Framework</code> generates <code>INNER JOIN</code> with <code>EXISTS</code> in response to <code>LINQ</code> <code>joins</code>. My expectation was just <code>INNER JOIN</code>. Need to spend some time to understand this. Anyway, the Execution Plan could be compared to manual.</p>

<p>After such success, I decided to go further. So next&#8230;</p>

<h3 id='short_4_what_about_join_by_id'>Short #4. What about JOIN by ID?</h3>

<pre><code>var r = from p in ds.OrderProducts
	join oi in ds.OrderItems 
		on p.OrderProductID equals oi.OrderProduct.OrderProductID
	where oi.Order.Customer.CustomerID == customerId
	select p;</code></pre>

<p>Damn, this works!</p>

<pre><code>exec sp_executesql N&#39;SELECT 
...
FROM   [Invoicing].[OrderProduct] AS [Extent1]
INNER JOIN [Invoicing].[OrderItem] AS [Extent2] 
	ON ([Extent1].[OrderProductID] = [Extent2].[OrderProductID]) 
		OR (([Extent1].[OrderProductID] IS NULL) 
		AND ([Extent2].[OrderProductID] IS NULL))
INNER JOIN [Invoicing].[Order] AS [Extent3] 
	ON [Extent2].[OrderID] = [Extent3].[OrderID]
WHERE [Extent3].[CustomerID] = @p__linq__1&#39;,N&#39;@p__linq__1 uniqueidentifier&#39;,
	@p__linq__1=&#39;F5DD85CF-CE1E-E2D1-3171-650938ABD2B7&#39;</code></pre>

<p>Now LINQ query looks not so cool. Hm. Entity Framework knows about primary keys. Why it cannot optimize this? I could not live with these results. So next:</p>

<h3 id='short_5_without_joins_at_all_projections'>Short #5. Without joins at all. Projections</h3>

<p>We can remove last <code>join</code> with simple projection.</p>

<pre><code>var r = from oi in ds.OrderItems
	where oi.Order.Customer.CustomerID == customerId
	select oi.OrderProduct;</code></pre>

<p>And yes, it works. Now Entity Framework generates this:</p>

<pre><code>exec sp_executesql N&#39;SELECT 
...
FROM   [Invoicing].[OrderItem] AS [Extent1]
INNER JOIN [Invoicing].[Order] AS [Extent2] 
	ON [Extent1].[OrderID] = [Extent2].[OrderID]
LEFT OUTER JOIN [Invoicing].[OrderProduct] AS [Extent3] 
	ON [Extent1].[OrderProductID] = [Extent3].[OrderProductID]
WHERE [Extent2].[CustomerID] = @p__linq__2&#39;,N&#39;@p__linq__2 uniqueidentifier&#39;,
	@p__linq__2=&#39;F5DD85CF-CE1E-E2D1-3171-650938ABD2B7&#39;</code></pre>

<p>Of course, execution plans look OK.</p>

<p>So can we stop here? No. At least not quite. The problem that all this queries are wrong&#8230; They do not distinct products. So next:</p>

<h3 id='short_6_intuitive__clause'>Short #6. Intuitive <code>where</code> clause</h3>

<p>Believing in the power of the Entity Framework, I decided to write everything into the where clause:</p>

<pre><code>var r = from p in ds.OrderProducts
	where p.OrderItems.Any(oi =&gt; oi.Order.Customer.CustomerID == customerId)
	select p;</code></pre>

<p>Result</p>

<pre><code>exec sp_executesql N&#39;SELECT 
...
FROM [Invoicing].[OrderProduct] AS [Extent1]
WHERE  EXISTS (SELECT 
	cast(1 as bit) AS [C1]
	FROM  [Invoicing].[OrderItem] AS [Extent2]
	INNER JOIN [Invoicing].[Order] AS [Extent3] 
		ON [Extent2].[OrderID] = [Extent3].[OrderID]
	WHERE ([Extent1].[OrderProductID] = [Extent2].[OrderProductID]) 
		AND ([Extent3].[CustomerID] = @p__linq__1)
)&#39;,N&#39;@p__linq__1 uniqueidentifier&#39;,@p__linq__1=&#39;F5DD85CF-CE1E-E2D1-3171-650938ABD2B7&#39;</code></pre>

<p>I am fully with these results. So this code will fly in production.</p>

<h3 id='conclusions'>Conclusions</h3>

<ol>
<li>Do not think in SQL terms when doing LINQ</li>

<li>Do check results</li>

<li>Reduce <code>join</code> clauses. <code>Where</code> clause has enough power</li>

<li>Use projections. Entity Framework support them</li>
</ol>

<p>Enjoy!</p>

<p><strong>UPDATE</strong> Unfortunately, this post does not provide right solution. Please see <a href='http://chaliy.name/blog/2009/9/the_right_way_to_do_inner_join_in_linq_to_entities'>The right way to do INNER JOIN in LINQ to Entity</a>.</p>
	<p class="entry-info">This entry was posted on 2009-09-17T17:50:00+00:00. <a href="http://chaliy.name/blog/2009/9/history_of_the_one_linq_query_to_entity_framework">Permalink</a></p>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript" src="http://disqus.com/forums/mikechaliy/embed.js"></script>
<noscript><a href="http://mikechaliy.disqus.com/?url=ref">View the discussion thread.</a></noscript>
		
	</div>
		
    	<div id="footer">        
       	Mike Chaliy &copy; Copyright 2009 
		&nbsp;|&nbsp;
		<a href="http://www.developers.org.ua" >
			<img width="80" height="15" border="0" alt="Участник планеты Developers.org.ua" src="http://www.developers.org.ua/static/images/planet/80x15_green.gif" />
		</a>
		&nbsp;|&nbsp;			
		<a rel="license" href="http://creativecommons.org/licenses/by/3.0/">
			<img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a><br />
			This <span xmlns:dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" rel="dc:type">work</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://chaliy.name" property="cc:attributionName" rel="cc:attributionURL">Mike Chaliy</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.
    </div>
	<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-265957-3");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
